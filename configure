#!/bin/bash

[ "$1" == "apply" ] && apply=1 || apply=0
[ $apply == 0 ] && echo "This is a dry-run, use '$0 apply'"

get_destination() {
  if [ -f "$1" ]; then
    grep -m 1 "*>" "$1" | \
    sed 's/" \*>\|# \*>\|\/\/ \*>//g' | \
    sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
  elif [ -d "$1" ] && [ -f "$1/.dest" ]; then
    cat $1/.dest
  fi
}

find . -mindepth 2 -not -path '*/\.*' | while read -r file; do
  file_path=$(realpath "$file")
  destination=$(get_destination "$file")

  if [[ -z "$destination" ]]; then
    continue
  fi

  echo -n "$file *> $destination"
  destination="${destination/#\~/$HOME}"

  mkdir -p "$(dirname "$symlink_dest")"

  if [[ -e "$destination" || -L "$destination" ]]; then
    override=1
    [ $apply == 1 ] && msg="replaced" || msg="replace"
  else
    override=0
    [ $apply == 1 ] && msg="created" || msg="create"
  fi

  if [ $apply == 0 ]; then
    echo -n " [$msg]"
  else
    [ $override == 1 ] && rm -rf $destination
    ln -s "$file_path" "$destination" && \
    echo -n " [$msg]" || \
    echo -n " [failed]"
  fi
  echo
done